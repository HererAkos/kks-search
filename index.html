<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <title>KKS Keres≈ë</title>
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #252525;
            --bg-quaternary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --border-color: #333;
            --accent-color: #64b5f6;
            --button-primary: #1a73e8;
        }
        
        body.light-theme {
            --bg-primary: #e5e5e5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ffffff;
            --bg-quaternary: #f5f5f5;
            --text-primary: #2c2c2c;
            --text-secondary: #666666;
            --border-color: #d0d0d0;
            --accent-color: #1a73e8;
            --button-primary: #1a73e8;
        }
        
        body.light-theme {
            background: #e5e5e5;
        }
        
        body.light-theme .phone-frame {
            background: #f0f0f0;
        }
        
        body.light-theme .screen {
            background: #f8f8f8;
        }
        
        body.light-theme .search-section {
            background: #f8f8f8;
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .search-input {
            background: #ffffff;
            border-color: #d0d0d0;
            color: #2c2c2c;
        }
        
        body.light-theme .search-input::placeholder {
            color: #666;
        }
        
        body.light-theme .search-hint,
        body.light-theme .long-press-hint,
        body.light-theme .breadcrumb {
            color: #666;
            background: #ffffff;
        }
        
        body.light-theme .result-item,
        body.light-theme .equipment-item {
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .result-kks,
        body.light-theme .equipment-kks {
            color: #1a73e8;
        }
        
        body.light-theme .result-name,
        body.light-theme .equipment-name,
        body.light-theme .hierarchy-title {
            color: #2c2c2c;
        }
        
        body.light-theme .result-path,
        body.light-theme .hierarchy-subtitle {
            color: #666;
        }
        
        body.light-theme .hierarchy-item {
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        body.light-theme .hierarchy-header {
            background: #ffffff;
            color: #2c2c2c;
        }
        
        body.light-theme .hierarchy-header:active,
        body.light-theme .child-item:active {
            background: #f0f0f0;
        }
        
        body.light-theme .hierarchy-children {
            background: #fafafa;
        }
        
        body.light-theme .child-item {
            background: #fafafa;
            border-top: 1px solid #d0d0d0;
            color: #2c2c2c;
        }
        
        body.light-theme .bottom-nav {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }
        
        body.light-theme .nav-item {
            color: #666;
        }
        
        body.light-theme .nav-item.active {
            color: #1a73e8;
        }
        
        body.light-theme .edit-card {
            background: #ffffff;
            border: 1px solid #d0d0d0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        body.light-theme .back-button {
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
            color: #1a73e8;
        }
        
        body.light-theme .back-button-search {
            background: #e8e8e8;
            color: #2c2c2c;
        }
        
        body.light-theme .empty-placeholder {
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
            color: #999;
        }
        
        body.light-theme .modal-content {
            background: #ffffff;
        }
        
        body.light-theme .modal-title,
        body.light-theme .form-label {
            color: #2c2c2c;
        }
        
        body.light-theme .modal-btn.cancel {
            background: #e8e8e8;
            color: #2c2c2c;
        }
        
        body.light-theme .modal-btn.save {
            background: #1a73e8;
            color: white;
        }
        
        body.light-theme .form-input,
        body.light-theme .form-select {
            background: #fafafa;
            border-color: #d0d0d0;
            color: #2c2c2c;
        }
        
        body.light-theme .context-menu {
            background: #ffffff;
            border-color: #d0d0d0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        body.light-theme .context-menu-item {
            color: #2c2c2c;
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .edit-card-title {
            color: #1a73e8;
        }
        
        body.light-theme .hierarchy-header::after {
            color: #2c2c2c !important;
        }
        
        body.light-theme .add-item-button,
        body.light-theme .add-button {
            background: #1a73e8;
            color: white;
        }
        
        body.light-theme .detail-modal-content {
            background: #ffffff;
        }
        
        body.light-theme .detail-modal-row {
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .detail-modal-label {
            color: #666;
        }
        
        body.light-theme .detail-modal-value {
            color: #2c2c2c;
        }
        
        body.light-theme .detail-modal {
            background: rgba(0, 0, 0, 0.4);
        }
        
        body.light-theme .detail-modal-header {
            color: #1a73e8;
        }
        
        body.light-theme .chevron {
            color: #666 !important;
        }
        
        body.light-theme .hierarchy-add-bar {
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .hierarchy-add-text {
            color: #666;
        }
        
        body.light-theme .hierarchy-row-wrapper {
            background: #ffffff;
        }
        
        body.light-theme .hierarchy-add-item-btn {
            color: #1a73e8;
        }
        
        body.light-theme .equipment-header-bar {
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
        }
        
        body.light-theme .equipment-header-text {
            color: #666;
        }
        
        body.light-theme .equipment-kks-code {
            color: #1a73e8;
        }
        
        body.light-theme .equipment-name-text {
            color: #2c2c2c;
        }
        
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 152, 0, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInFromTop 0.3s ease-out;
            transition: all 0.3s;
        }
        
        .offline-indicator.online {
            background: rgba(76, 175, 80, 0.95);
        }
        
        .offline-indicator.hidden {
            display: none;
        }
        
        @keyframes slideInFromTop {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .offline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a url('huha_hatter.jpg') center center no-repeat;
            background-size: cover;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .phone-frame {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            overflow: hidden;
        }
        
        .status-bar {
            display: none;
        }
        
        .app-header {
            background: #1565c0;
            color: white;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .search-section {
            padding: 16px;
            background: #0d0d0d;
            border-bottom: 1px solid #222;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #333;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .search-input:focus {
            border-color: #1a73e8;
        }
        
        .search-input::placeholder {
            color: #888;
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-hint {
            margin-top: 8px;
            font-size: 12px;
            color: #999;
        }
        
        .bottom-nav {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 56px;
            background: #0d0d0d;
            border-top: 1px solid #222;
            display: flex;
            z-index: 1;
            padding: 0 15%;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            color: #999;
        }
        
        .nav-item:active {
            background: #2a2a2a;
        }
        
        .nav-item.active {
            color: #64b5f6;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 11px;
            letter-spacing: -0.5px;
        }
        
        .hierarchy-section {
            padding: 16px;
            padding-bottom: 80px;
        }
        
        .hierarchy-item {
            background: #0d0d0d;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .hierarchy-header {
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: none;
            background: #1e1e1e;
            width: 100%;
            text-align: left;
            color: #e0e0e0;
        }
        
        .hierarchy-header:active {
            background: #2a2a2a;
        }
        
        .hierarchy-title {
            font-size: 16px;
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .hierarchy-subtitle {
            font-size: 13px;
            color: #999;
            margin-top: 2px;
        }
        
        .chevron {
            color: #777;
            transition: transform 0.3s;
        }
        
        .chevron.expanded {
            transform: rotate(180deg);
        }
        
        .hierarchy-add-bar {
            padding: 12px 16px;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hierarchy-add-text {
            color: #999;
            font-size: 13px;
        }
        
        .hierarchy-add-btn {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hierarchy-row-wrapper {
            display: flex;
            align-items: center;
            background: #1e1e1e;
        }
        
        .hierarchy-flex-header {
            flex: 1;
            padding-right: 8px;
        }
        
        .hierarchy-add-item-btn {
            background: transparent;
            color: #64b5f6;
            border: none;
            padding: 14px 16px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .breadcrumb-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breadcrumb-add-btn {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .equipment-header-bar {
            padding: 8px 16px;
            background: #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        
        .equipment-header-text {
            color: #999;
            font-size: 13px;
        }
        
        .equipment-add-btn {
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            cursor: pointer;
        }
        
        .equipment-detail-item {
            padding: 10px 16px 10px 32px;
            cursor: pointer;
        }
        
        .equipment-kks-code {
            color: #64b5f6;
            font-size: 14px;
            font-weight: 600;
        }
        
        .equipment-name-text {
            color: #e0e0e0;
            font-size: 15px;
            margin-top: 2px;
        }
        
        .empty-equipment {
            padding: 12px 32px;
        }
        
        .hierarchy-children {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #252525;
        }
        
        .hierarchy-children.expanded {
            max-height: 1000px;
        }
        
        .child-item {
            padding: 12px 16px 12px 32px;
            border-top: 1px solid #333;
            cursor: pointer;
            background: #252525;
            border: none;
            width: 100%;
            text-align: left;
            color: #e0e0e0;
        }
        
        .child-item:active {
            background: #2a2a2a;
        }
        
        .search-results {
            display: none;
        }
        
        .search-results.active {
            display: block;
        }
        
        .result-item {
            background: #0d0d0d;
            padding: 14px 16px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            position: relative;
        }
        
        .result-item:active {
            background: #2a2a2a;
        }
        
        .result-kks {
            font-size: 13px;
            color: #64b5f6;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .result-name {
            font-size: 16px;
            color: #e0e0e0;
            margin-bottom: 6px;
        }
        
        .result-path {
            font-size: 12px;
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .screen {
            display: none;
            height: calc(100vh - 56px - 60px);
            height: calc(-webkit-fill-available - 56px - 60px);
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }
        
        .screen.active {
            display: block;
        }
        
        .back-button {
            padding: 12px 16px;
            background: #1e1e1e;
            border: none;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
            color: #64b5f6;
            width: 100%;
        }
        
        .back-button:active {
            background: #2a2a2a;
        }
        
        .breadcrumb {
            padding: 12px 16px;
            background: #252525;
            font-size: 13px;
            color: #999;
            border-bottom: 1px solid #333;
        }
        
        .equipment-item {
            background: #1e1e1e;
            padding: 14px 16px;
            border-bottom: 1px solid #333;
            position: relative;
        }
        
        .equipment-kks {
            font-size: 13px;
            color: #64b5f6;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .equipment-name {
            font-size: 16px;
            color: #e0e0e0;
        }
        
        .empty-placeholder {
            padding: 14px 16px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            color: #666;
            font-style: italic;
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            min-width: 150px;
        }
        
        .context-menu.active {
            display: block;
        }
        
        .context-menu-item {
            padding: 12px 16px;
            color: #e0e0e0;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: #333;
        }
        
        .context-menu-item.delete {
            color: #ff6b6b;
        }
        
        /* Edit Screen */
        .edit-section {
            padding: 0;
            padding-bottom: 20px;
        }
        
        .edit-nav-screen {
            display: none;
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .edit-nav-screen.active {
            display: block;
        }
        
        .add-button {
            width: 100%;
            padding: 14px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 16px;
        }
        
        .add-button:active {
            background: #1557b0;
        }
        
        .edit-card {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .edit-card-title {
            color: #64b5f6;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .edit-list {
            background: transparent;
            border-radius: 0;
            overflow: visible;
            margin: 0;
        }
        
        .edit-list-item {
            padding: 14px 16px;
            border-bottom: none;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .edit-list-item:last-child {
            border-bottom: none;
            margin-bottom: 8px;
        }
        
        body.light-theme .edit-list-item {
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .edit-actions {
            display: flex;
            gap: 8px;
        }
        
        .edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .edit-btn.edit {
            background: #1a73e8;
            color: white;
        }
        
        .edit-btn.delete {
            background: #ff6b6b;
            color: white;
        }
        
        /* Edit Tabs */
        .edit-tabs-nav {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .edit-tabs-nav::-webkit-scrollbar {
            display: none;
        }
        
        .edit-tab {
            flex: 1;
            min-width: 90px;
            padding: 14px 8px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .edit-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .edit-tab:active {
            background: var(--bg-tertiary);
        }
        
        .edit-tab-content {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .edit-tab-content.active {
            display: block;
        }
        
        .add-button-large {
            width: calc(100% - 32px);
            margin: 16px;
            padding: 14px;
            background: var(--button-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .add-button-large:active {
            opacity: 0.8;
        }
        
        .data-button {
            width: calc(100% - 32px);
            margin: 0 16px 12px 16px;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .data-button:active {
            opacity: 0.8;
        }
        
        .data-button.export {
            background: #ff6b6b;
            color: white;
        }
        
        .data-button.import {
            background: #51cf66;
            color: white;
        }
        
        /* Settings Screen */
        .settings-section {
            padding: 16px;
        }
        
        .settings-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        body.light-theme .settings-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
        }
        
        .settings-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .theme-toggle-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            transition: transform 0.2s ease;
            line-height: 1;
            outline: none;
        }
        
        .theme-toggle-btn:hover {
            transform: scale(1.15);
        }
        
        .theme-toggle-btn:active {
            transform: scale(0.95);
        }
        
        .theme-toggle-btn .toggle-emoji {
            display: block;
        }
        
        .settings-button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
            text-align: left;
        }
        
        .settings-button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .settings-button span {
            font-size: 28px;
        }
        
        .settings-button-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .settings-button-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .settings-button.export {
            border: 2px solid #ff6b6b;
        }
        
        .settings-button.import {
            border: 2px solid #51cf66;
        }
        
        .settings-footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            padding: 20px;
        }
        
        .jesus-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            padding: 4px;
            background: #1a1a1a;
            transition: background 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        body.light-theme .jesus-icon {
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            color: #e0e0e0;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            color: #999;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 15px;
            outline: none;
        }
        
        .form-input:focus, .form-select:focus {
            border-color: #1a73e8;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .modal-btn.cancel {
            background: #333;
            color: #e0e0e0;
        }
        
        .modal-btn.save {
            background: #1a73e8;
            color: white;
        }
        
        /* Detail Modal */
        .detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .detail-modal.active {
            display: flex;
        }
        
        .detail-modal-content {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        .detail-modal-header {
            font-size: 18px;
            font-weight: 600;
            color: #64b5f6;
            margin-bottom: 16px;
        }
        
        .detail-modal-row {
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        
        .detail-modal-row:last-child {
            border-bottom: none;
        }
        
        .detail-modal-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }
        
        .detail-modal-value {
            font-size: 15px;
            color: #e0e0e0;
        }
        
        .back-button-search {
            padding: 8px 16px;
            background: #333;
            color: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 12px;
        }
        
        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 70px;
            left: 16px;
            right: 16px;
            background: #1565c0;
            color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .install-banner.show {
            display: flex;
        }
        
        .install-banner-content {
            flex: 1;
        }
        
        .install-banner-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .install-banner-text {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .install-banner-btn {
            background: white;
            color: #1565c0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }
        
        .install-banner-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Password Login Screen -->
    <div id="loginScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('huha_hatter.jpg') center center no-repeat; background-size: cover; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000;">
        <div id="loginBox" style="background: rgba(30, 30, 30, 0.95); padding: 40px; border-radius: 16px; box-shadow: 0 10px 50px rgba(0,0,0,0.5); text-align: center; max-width: 320px; width: 90%;">
            <div style="font-size: 48px; margin-bottom: 20px;">üîí</div>
            <h2 style="color: #e0e0e0; margin-bottom: 10px; font-size: 24px;">KKS Keres≈ë</h2>
            <p style="color: #999; margin-bottom: 30px; font-size: 14px;">K√©rlek add meg a jelsz√≥t</p>
            <input type="password" id="passwordInput" placeholder="Jelsz√≥" readonly onfocus="this.removeAttribute('readonly');" style="width: 100%; padding: 14px; background: #2a2a2a; border: 2px solid #444; border-radius: 8px; color: #e0e0e0; font-size: 16px; margin-bottom: 20px; outline: none; box-sizing: border-box;" />
            <button onclick="checkPassword()" style="width: 100%; padding: 14px; background: #1a73e8; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Bel√©p√©s</button>
            <div id="errorMessage" style="color: #ff6b6b; margin-top: 15px; font-size: 14px; display: none;">‚ùå Hib√°s jelsz√≥!</div>
        </div>
    </div>
    
    <div class="phone-frame" id="mainApp" style="display: none;">
        <!-- Offline Indicator -->
        <div class="offline-indicator hidden" id="offlineIndicator">
            <div class="offline-dot"></div>
            <span id="offlineText">Offline m√≥d</span>
        </div>
        
        <div class="status-bar">
            <span id="currentTime">14:30</span>
            <span>üì∂ üîã</span>
        </div>
        
        <div class="app-header">
            <div class="app-title">KKS Keres≈ë</div>
        </div>
        
        <!-- Keres≈ë K√©perny≈ë -->
        <div class="screen active" id="searchScreen">
            <div class="search-section">
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <button class="back-button-search" id="searchBackButton" onclick="clearSearch()" style="display: none;">‚Üê Vissza</button>
                </div>
                <div class="search-box">
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="KKS k√≥d vagy berendez√©s neve..."
                        id="searchInput"
                    >
                    <span class="search-icon">üîç</span>
                </div>
                <div class="search-hint">Pl.: "13ETG10" vagy "szivatty√∫"</div>
            </div>
            
            <div class="search-results" id="searchResults">
            </div>
            
            <div class="empty-state" id="emptyState">
                <div style="font-size: 48px; margin-bottom: 12px;">üîç</div>
                <div>√çrj be egy KKS k√≥dot vagy<br>berendez√©s nevet a keres√©shez</div>
            </div>
        </div>
        
        <!-- Hierarchia K√©perny≈ë -->
        <div class="screen" id="hierarchyScreen">
            <div id="hierarchyContent"></div>
        </div>
        
        <!-- Szerkeszt√©s K√©perny≈ë -->
        <div class="screen" id="editScreen">
            <!-- Edit Navigation - Rooms List -->
            <div class="edit-nav-screen active" id="editNavRooms">
                <div class="edit-section">
                    <button class="add-button-large" onclick="openAddModal('room')">+ √öj Kapcsol√≥t√©r</button>
                    <div class="edit-list" id="editRoomsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Be√°ll√≠t√°sok K√©perny≈ë -->
        <div class="screen" id="settingsScreen">
            <div class="settings-section">
                <!-- Statisztika -->
                <div class="settings-card">
                    <div class="settings-card-title">üìä Statisztika</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon">üè¢</div>
                            <div class="stat-value" id="statRooms">0</div>
                            <div class="stat-label">Kapcsol√≥t√©r</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-value" id="statDistributors">0</div>
                            <div class="stat-label">Eloszt√≥</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">üîå</div>
                            <div class="stat-value" id="statBranches">0</div>
                            <div class="stat-label">Le√°gaz√°s</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">‚öôÔ∏è</div>
                            <div class="stat-value" id="statEquipment">0</div>
                            <div class="stat-label">Berendez√©s</div>
                        </div>
                    </div>
                </div>
                
                <!-- Megjelen√©s -->
                <div class="settings-card">
                    <div class="settings-card-title">üé® Megjelen√©s</div>
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-name">T√©ma</div>
                            <div class="setting-description">Vil√°gos vagy s√∂t√©t m√≥d</div>
                        </div>
                        <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()">
                            <span class="toggle-emoji" id="toggleEmoji">üåô</span>
                        </button>
                    </div>
                </div>
                
                <!-- Adatok kezel√©se -->
                <div class="settings-card">
                    <div class="settings-card-title">üíæ Adatok kezel√©se</div>
                    <button class="settings-button export" onclick="exportData()">
                        <span>üì§</span>
                        <div>
                            <div class="settings-button-title">Adatok export√°l√°sa</div>
                            <div class="settings-button-desc">JSON f√°jl let√∂lt√©se</div>
                        </div>
                    </button>
                    <button class="settings-button import" onclick="document.getElementById('importFileInput').click()">
                        <span>üì•</span>
                        <div>
                            <div class="settings-button-title">Adatok import√°l√°sa</div>
                            <div class="settings-button-desc">JSON f√°jl felt√∂lt√©se</div>
                        </div>
                    </button>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importDataFromFile(this)" />
                </div>
                
                <!-- Verzi√≥ info -->
                <div class="settings-footer">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <img src="jesus.png" alt="üôè" class="jesus-icon">
                        <div>KKS Keres≈ë v1.0</div>
                        <img src="jesus.png" alt="üôè" class="jesus-icon">
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">¬© 2026</div>
                </div>
            </div>
        </div>
        
        <!-- Als√≥ navig√°ci√≥ -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab(0, this)">
                <div class="nav-icon">üîç</div>
                <div class="nav-label">Keres√©s</div>
            </button>
            <button class="nav-item" onclick="switchTab(1, this)">
                <div class="nav-icon">üìã</div>
                <div class="nav-label">Hierarchia</div>
            </button>
            <button class="nav-item" onclick="switchTab(2, this)">
                <div class="nav-icon">‚úèÔ∏è</div>
                <div class="nav-label">Szerkeszt√©s</div>
            </button>
            <button class="nav-item" onclick="switchTab(3, this)">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Be√°ll√≠t√°sok</div>
            </button>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editFromContext()">‚úèÔ∏è Szerkeszt√©s</div>
        <div class="context-menu-item delete" onclick="deleteFromContext()">üóëÔ∏è T√∂rl√©s</div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div class="modal" id="addEditModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">√öj elem hozz√°ad√°sa</div>
            <div id="modalForm"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal()">M√©gse</button>
                <button class="modal-btn save" onclick="saveModal()">Ment√©s</button>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div class="detail-modal" id="detailModal" onclick="closeDetailModal()">
        <div class="detail-modal-content" onclick="event.stopPropagation()">
            <div class="detail-modal-header" id="detailModalTitle"></div>
            <div id="detailModalContent"></div>
        </div>
    </div>
    
    <!-- PWA Install Banner -->
    <div class="install-banner" id="installBanner">
        <div class="install-banner-content">
            <div class="install-banner-title">üì± Telep√≠tsd az appot!</div>
            <div class="install-banner-text">Gyorsabb, offline is m≈±k√∂dik</div>
        </div>
        <button class="install-banner-btn" id="installBtn">Telep√≠t√©s</button>
        <button class="install-banner-close" id="installClose">‚úï</button>
    </div>
    
    <script>
        // ============= THEME TOGGLE =============
        function toggleTheme() {
            const body = document.body;
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const toggleEmoji = document.getElementById('toggleEmoji');
            
            // Get or create theme-color meta tag
            let metaThemeColor = document.querySelector("meta[name='theme-color']");
            if (!metaThemeColor) {
                metaThemeColor = document.createElement('meta');
                metaThemeColor.name = 'theme-color';
                document.head.appendChild(metaThemeColor);
            }
            
            // Get or create apple status bar meta tag
            let appleStatusBar = document.querySelector("meta[name='apple-mobile-web-app-status-bar-style']");
            if (!appleStatusBar) {
                appleStatusBar = document.createElement('meta');
                appleStatusBar.name = 'apple-mobile-web-app-status-bar-style';
                document.head.appendChild(appleStatusBar);
            }
            
            if (currentTheme === 'dark') {
                body.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                if (toggleEmoji) toggleEmoji.textContent = '‚òÄÔ∏è';
                // Light theme - white/light status bar
                metaThemeColor.content = '#ffffff';
                appleStatusBar.content = 'default';
            } else {
                body.classList.remove('light-theme');
                localStorage.setItem('theme', 'dark');
                if (toggleEmoji) toggleEmoji.textContent = 'üåô';
                // Dark theme - dark status bar
                metaThemeColor.content = '#000000';
                appleStatusBar.content = 'black-translucent';
            }
            
            // Update settings button if it exists
            updateStatistics();
        }
        
        function loadTheme() {
            const theme = localStorage.getItem('theme') || 'dark';
            const toggleEmoji = document.getElementById('toggleEmoji');
            
            // Get or create theme-color meta tag
            let metaThemeColor = document.querySelector("meta[name='theme-color']");
            if (!metaThemeColor) {
                metaThemeColor = document.createElement('meta');
                metaThemeColor.name = 'theme-color';
                document.head.appendChild(metaThemeColor);
            }
            
            // Get or create apple status bar meta tag
            let appleStatusBar = document.querySelector("meta[name='apple-mobile-web-app-status-bar-style']");
            if (!appleStatusBar) {
                appleStatusBar = document.createElement('meta');
                appleStatusBar.name = 'apple-mobile-web-app-status-bar-style';
                document.head.appendChild(appleStatusBar);
            }
            
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                if (toggleEmoji) toggleEmoji.textContent = '‚òÄÔ∏è';
                // Light theme - white/light status bar
                metaThemeColor.content = '#ffffff';
                appleStatusBar.content = 'default';
            } else {
                if (toggleEmoji) toggleEmoji.textContent = 'üåô';
                // Dark theme - dark status bar
                metaThemeColor.content = '#000000';
                appleStatusBar.content = 'black-translucent';
            }
        }
        
        // ============= PASSWORD PROTECTION =============
        const CORRECT_PASSWORD = '2344';
        
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            const error = document.getElementById('errorMessage');
            
            if (input.value === CORRECT_PASSWORD) {
                // Correct password - save to sessionStorage
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initApp();
            } else {
                // Wrong password
                error.style.display = 'block';
                input.value = '';
                input.style.borderColor = '#ff6b6b';
                setTimeout(() => {
                    input.style.borderColor = '#444';
                }, 1000);
            }
        }
        
        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('passwordInput');
            
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
            }
            
            // Check if already authenticated
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initApp();
            }
        });
        
        // ============= DATA STRUCTURE =============
        let appData = {
            rooms: [],
            distributors: [],
            branches: [],
            equipment: []
        };
        
        let contextMenuTarget = null;
        let longPressTimer = null;
        let currentModalType = null;
        let editingItemId = null;
        
        // ============= INITIALIZATION =============
        function initApp() {
            loadFromLocalStorage();
            loadTheme();
            updateTime();
            setInterval(updateTime, 60000);
            renderAll();
            
            // Prevent viewport resize on keyboard open
            const viewportHeight = window.innerHeight;
            document.documentElement.style.setProperty('--viewport-height', `${viewportHeight}px`);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.height = '100%';
            
            // Close context menu on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    closeContextMenu();
                }
            });
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
        }
        
        // ============= LOCAL STORAGE =============
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('equipmentAppData');
            if (saved) {
                appData = JSON.parse(saved);
            } else {
                // √úres kezd≈ë adatok
                appData = {
                    rooms: [],
                    distributors: [],
                    branches: [],
                    equipment: []
                };
                saveToLocalStorage();
            }
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('equipmentAppData', JSON.stringify(appData));
        }
        
        // ============= RENDER FUNCTIONS =============
        function renderAll() {
            renderSearchResults();
            renderHierarchy();
            renderEditScreen();
        }
        
        function renderSearchResults() {
            // Empty by default, will be filled by search
        }
        
        function renderHierarchy() {
            const container = document.getElementById('hierarchyContent');
            container.innerHTML = '<div class="hierarchy-section">';
            
            appData.rooms.forEach(room => {
                const dists = appData.distributors.filter(d => d.roomId === room.id);
                container.innerHTML += `
                    <div class="hierarchy-item">
                        <button class="hierarchy-header" onclick="showRoomDetails('${room.id}')" data-type="room" data-id="${room.id}">
                            <div>
                                <div class="hierarchy-title">${room.name}</div>
                                <div class="hierarchy-subtitle">${dists.length} eloszt√≥</div>
                            </div>
                            <span class="chevron">‚Ä∫</span>
                        </button>
                    </div>
                `;
            });
            
            container.innerHTML += '</div>';
            setupLongPress();
        }
        
        function toggleDistributor(button) {
            const branches = button.parentElement.nextElementSibling;
            if (!branches) return;
            
            const chevron = button.querySelector('.chevron');
            if (!chevron) return;
            
            if (branches.classList.contains('expanded')) {
                branches.classList.remove('expanded');
                branches.style.maxHeight = '0';
                chevron.classList.remove('expanded');
            } else {
                branches.classList.add('expanded');
                branches.style.maxHeight = branches.scrollHeight + 'px';
                chevron.classList.add('expanded');
            }
        }
        
        function showRoomDetails(roomId) {
            const room = appData.rooms.find(r => r.id === roomId);
            if (!room) return;
            
            const dists = appData.distributors.filter(d => d.roomId === roomId);
            
            // Create a new screen for room details
            const screenDiv = document.createElement('div');
            screenDiv.className = 'screen active';
            screenDiv.id = `roomDetail_${roomId}`;
            
            screenDiv.innerHTML = `
                <div class="back-button" onclick="goBackToHierarchy()">
                    ‚Üê Vissza
                </div>
                <div class="hierarchy-section" style="padding: 16px;">
                    <div class="breadcrumb" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
                        ${room.name}
                    </div>
                    ${dists.map(dist => {
                        const branches = appData.branches.filter(b => b.distId === dist.id);
                        return `
                            <div class="hierarchy-item" style="margin-bottom: 8px;">
                                <button class="hierarchy-header" onclick="showDistributorDetails('${dist.id}')" data-type="distributor" data-id="${dist.id}">
                                    <div>
                                        <div class="hierarchy-title">${dist.code}</div>
                                        <div class="hierarchy-subtitle">${dist.name} - ${branches.length} le√°gaz√°s</div>
                                    </div>
                                    <span class="chevron">‚Ä∫</span>
                                </button>
                            </div>
                        `;
                    }).join('') || '<div class="empty-placeholder">Nincs eloszt√≥ ebben a kapcsol√≥t√©rben</div>'}
                </div>
            `;
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Add new screen before bottom nav
            const bottomNav = document.querySelector('.bottom-nav');
            bottomNav.parentNode.insertBefore(screenDiv, bottomNav);
            
            setupLongPress();
        }
        
        function renderEditScreen() {
            // Render rooms list with navigation
            const roomsList = document.getElementById('editRoomsList');
            roomsList.innerHTML = appData.rooms.length > 0 
                ? appData.rooms.map(room => {
                    const dists = appData.distributors.filter(d => d.roomId === room.id);
                    return `
                        <div class="edit-list-item" onclick="showEditRoomDistributors('${room.id}')">
                            <div>
                                <div style="font-weight: 500;">${room.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${dists.length} eloszt√≥</div>
                            </div>
                            <div class="edit-actions" onclick="event.stopPropagation()">
                                <button class="edit-btn edit" onclick="editItem('room', '${room.id}')">‚úèÔ∏è</button>
                                <button class="edit-btn delete" onclick="deleteItem('room', '${room.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<div class="empty-placeholder">M√©g nincs kapcsol√≥t√©r. Kattints a + gombra az els≈ë hozz√°ad√°s√°hoz!</div>';
        }
        
        // ============= CONTEXTUAL EDIT NAVIGATION =============
        function showEditRoomDistributors(roomId) {
            const room = appData.rooms.find(r => r.id === roomId);
            if (!room) return;
            
            const dists = appData.distributors.filter(d => d.roomId === roomId);
            
            // Create screen if it doesn't exist
            let screen = document.getElementById('editNavDist_' + roomId);
            if (screen) {
                screen.remove();
            }
            
            const editScreen = document.getElementById('editScreen');
            const newScreen = document.createElement('div');
            newScreen.className = 'edit-nav-screen active';
            newScreen.id = 'editNavDist_' + roomId;
            newScreen.innerHTML = `
                <div class="back-button" onclick="goBackToEditRooms()">‚Üê Vissza</div>
                <div class="edit-section">
                    <div class="breadcrumb" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin: 16px; font-size: 13px; color: var(--text-secondary);">
                        ${room.name}
                    </div>
                    <button class="add-button-large" onclick="openAddDistributorModal('${roomId}')">+ √öj Eloszt√≥</button>
                    <div class="edit-list">
                        ${dists.map(dist => {
                            const branches = appData.branches.filter(b => b.distId === dist.id);
                            return `
                                <div class="edit-list-item" onclick="showEditDistBranches('${dist.id}')">
                                    <div>
                                        <div style="font-weight: 500;">${dist.code} - ${dist.name}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${branches.length} le√°gaz√°s</div>
                                    </div>
                                    <div class="edit-actions" onclick="event.stopPropagation()">
                                        <button class="edit-btn edit" onclick="editItem('distributor', '${dist.id}')">‚úèÔ∏è</button>
                                        <button class="edit-btn delete" onclick="deleteItem('distributor', '${dist.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('') || '<div class="empty-placeholder">M√©g nincs eloszt√≥</div>'}
                    </div>
                </div>
            `;
            
            // Hide current screen
            document.querySelectorAll('.edit-nav-screen').forEach(s => s.classList.remove('active'));
            editScreen.appendChild(newScreen);
        }
        
        function showEditDistBranches(distId) {
            const dist = appData.distributors.find(d => d.id === distId);
            if (!dist) return;
            
            const room = appData.rooms.find(r => r.id === dist.roomId);
            const branches = appData.branches.filter(b => b.distId === distId);
            
            const editScreen = document.getElementById('editScreen');
            const newScreen = document.createElement('div');
            newScreen.className = 'edit-nav-screen active';
            newScreen.id = 'editNavBranch_' + distId;
            newScreen.innerHTML = `
                <div class="back-button" onclick="goBackToEditDistributors('${dist.roomId}')">‚Üê Vissza</div>
                <div class="edit-section">
                    <div class="breadcrumb" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin: 16px; font-size: 13px; color: var(--text-secondary);">
                        ${room.name} ‚Ä∫ ${dist.code}
                    </div>
                    <button class="add-button-large" onclick="openAddBranchModal('${distId}')">+ √öj Le√°gaz√°s</button>
                    <div class="edit-list">
                        ${branches.map(branch => {
                            const equipment = appData.equipment.filter(e => e.branchId === branch.id);
                            return `
                                <div class="edit-list-item" onclick="showEditBranchEquipment('${branch.id}')">
                                    <div>
                                        <div style="font-weight: 500;">${branch.name}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${equipment.length} berendez√©s</div>
                                    </div>
                                    <div class="edit-actions" onclick="event.stopPropagation()">
                                        <button class="edit-btn edit" onclick="editItem('branch', '${branch.id}')">‚úèÔ∏è</button>
                                        <button class="edit-btn delete" onclick="deleteItem('branch', '${branch.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `;
                        }).join('') || '<div class="empty-placeholder">M√©g nincs le√°gaz√°s</div>'}
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.edit-nav-screen').forEach(s => s.classList.remove('active'));
            editScreen.appendChild(newScreen);
        }
        
        function showEditBranchEquipment(branchId) {
            const branch = appData.branches.find(b => b.id === branchId);
            if (!branch) return;
            
            const dist = appData.distributors.find(d => d.id === branch.distId);
            const room = dist ? appData.rooms.find(r => r.id === dist.roomId) : null;
            const equipment = appData.equipment.filter(e => e.branchId === branchId);
            
            const editScreen = document.getElementById('editScreen');
            const newScreen = document.createElement('div');
            newScreen.className = 'edit-nav-screen active';
            newScreen.id = 'editNavEquip_' + branchId;
            newScreen.innerHTML = `
                <div class="back-button" onclick="goBackToEditBranches('${branch.distId}')">‚Üê Vissza</div>
                <div class="edit-section">
                    <div class="breadcrumb" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin: 16px; font-size: 13px; color: var(--text-secondary);">
                        ${room ? room.name + ' ‚Ä∫ ' : ''}${dist ? dist.code + ' ‚Ä∫ ' : ''}${branch.name}
                    </div>
                    <button class="add-button-large" onclick="openAddEquipmentModal('${branchId}')">+ √öj Berendez√©s</button>
                    <div class="edit-list">
                        ${equipment.map(eq => `
                            <div class="edit-list-item">
                                <div>
                                    <div style="color: var(--accent-color); font-weight: 600;">${eq.kks || '(KKS n√©lk√ºl)'}</div>
                                    <div style="margin-top: 2px;">${eq.name}</div>
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Mez≈ë ${eq.field}</div>
                                </div>
                                <div class="edit-actions">
                                    <button class="edit-btn edit" onclick="editItem('equipment', '${eq.id}')">‚úèÔ∏è</button>
                                    <button class="edit-btn delete" onclick="deleteItem('equipment', '${eq.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('') || '<div class="empty-placeholder">M√©g nincs berendez√©s</div>'}
                    </div>
                </div>
            `;
            
            document.querySelectorAll('.edit-nav-screen').forEach(s => s.classList.remove('active'));
            editScreen.appendChild(newScreen);
        }
        
        function goBackToEditRooms() {
            document.querySelectorAll('[id^="editNavDist_"]').forEach(s => s.remove());
            // Refresh the rooms list to show updated distributor counts
            renderEditScreen();
            document.getElementById('editNavRooms').classList.add('active');
        }
        
        function goBackToEditDistributors(roomId) {
            document.querySelectorAll('[id^="editNavBranch_"]').forEach(s => s.remove());
            // Always regenerate the distributor screen to show updated data
            showEditRoomDistributors(roomId);
        }
        
        function goBackToEditBranches(distId) {
            document.querySelectorAll('[id^="editNavEquip_"]').forEach(s => s.remove());
            // Always regenerate the branch screen to show updated data
            showEditDistBranches(distId);
        }
        
        function getEquipmentPath(eq) {
            const branch = appData.branches.find(b => b.id === eq.branchId);
            if (!branch) return 'N/A';
            
            const dist = appData.distributors.find(d => d.id === branch.distId);
            if (!dist) return 'N/A';
            
            const room = appData.rooms.find(r => r.id === dist.roomId);
            if (!room) return 'N/A';
            
            return `${room.name} ‚Ä∫ ${dist.code} ‚Ä∫ ${branch.name} ‚Ä∫ Mez≈ë ${eq.field}`;
        }
        
        // ============= SEARCH FUNCTIONALITY =============
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const emptyState = document.getElementById('emptyState');
        const searchBackButton = document.getElementById('searchBackButton');
        
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length === 0) {
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
                emptyState.style.display = 'block';
                searchBackButton.style.display = 'none';
                return;
            }
            
            const filtered = appData.equipment.filter(eq => 
                eq.kks.toLowerCase().includes(query) || 
                eq.name.toLowerCase().includes(query)
            );
            
            if (filtered.length > 0) {
                emptyState.style.display = 'none';
                searchResults.classList.add('active');
                searchBackButton.style.display = 'block';
                
                searchResults.innerHTML = filtered.map(eq => {
                    const path = getEquipmentPath(eq);
                    return `
                        <div class="result-item" onclick="showEquipmentDetail('${eq.id}')" data-type="equipment" data-id="${eq.id}">
                            <div class="result-kks">${eq.kks || '(KKS n√©lk√ºl)'}</div>
                            <div class="result-name">${eq.name}</div>
                            <div class="result-path">${path}</div>
                        </div>
                    `;
                }).join('');
                
                setupLongPress();
            } else {
                searchResults.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: #666;">Nincs tal√°lat</div>';
                searchResults.classList.add('active');
                emptyState.style.display = 'none';
                searchBackButton.style.display = 'block';
            }
        });
        
        // ============= NAVIGATION =============
        function toggleHierarchy(button) {
            // Find the parent hierarchy-item div
            const hierarchyItem = button.closest('.hierarchy-item');
            if (!hierarchyItem) return;
            
            // Find the children div within this hierarchy-item
            const children = hierarchyItem.querySelector('.hierarchy-children');
            if (!children) return;
            
            const chevron = button.querySelector('.chevron');
            if (!chevron) return;
            
            children.classList.toggle('expanded');
            chevron.classList.toggle('expanded');
        }
        
        function switchTab(index, button) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            button.classList.add('active');
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const screens = ['searchScreen', 'hierarchyScreen', 'editScreen', 'settingsScreen'];
            document.getElementById(screens[index]).classList.add('active');
            
            // Reset edit navigation to rooms when switching to edit tab
            if (index === 2) {
                document.querySelectorAll('[id^="editNavDist_"], [id^="editNavBranch_"], [id^="editNavEquip_"]').forEach(s => s.remove());
                document.querySelectorAll('.edit-nav-screen').forEach(s => s.classList.remove('active'));
                document.getElementById('editNavRooms').classList.add('active');
            }
            
            // Update statistics when opening settings
            if (index === 3) {
                updateStatistics();
            }
        }
        
        function updateStatistics() {
            document.getElementById('statRooms').textContent = appData.rooms.length;
            document.getElementById('statDistributors').textContent = appData.distributors.length;
            document.getElementById('statBranches').textContent = appData.branches.length;
            document.getElementById('statEquipment').textContent = appData.equipment.length;
            
            // Update theme button
            const themeBtn = document.getElementById('themeToggleBtn');
            const currentTheme = localStorage.getItem('theme') || 'dark';
            themeBtn.textContent = currentTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function showDistributorDetails(distId) {
            const dist = appData.distributors.find(d => d.id === distId);
            if (!dist) return;
            
            const room = appData.rooms.find(r => r.id === dist.roomId);
            const branches = appData.branches.filter(b => b.distId === distId);
            
            // Create a new screen dynamically
            const existingScreen = document.getElementById('distDetail_' + distId);
            if (existingScreen) {
                existingScreen.remove();
            }
            
            const screenDiv = document.createElement('div');
            screenDiv.className = 'screen active';
            screenDiv.id = 'distDetail_' + distId;
            screenDiv.innerHTML = `
                <button class="back-button" onclick="goBackToRoom('${dist.roomId}')">
                    ‚Üê Vissza
                </button>
                <div class="breadcrumb" style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin: 16px; font-size: 13px; color: var(--text-secondary);">
                    ${room.name} ‚Ä∫ ${dist.code}
                </div>
                <div class="hierarchy-section">
                    ${branches.map(branch => {
                        const equipment = appData.equipment.filter(e => e.branchId === branch.id);
                        return `
                            <div class="hierarchy-item">
                                <div class="hierarchy-add-bar">
                                    <div class="hierarchy-add-text">${branch.name}</div>
                                </div>
                                <div class="hierarchy-children expanded" style="max-height: none;">
                                    ${equipment.map(eq => `
                                        <div class="child-item equipment-detail-item" onclick="showEquipmentDetail('${eq.id}')" data-type="equipment" data-id="${eq.id}">
                                            <div class="equipment-kks-code">${eq.kks || '(KKS n√©lk√ºl)'}</div>
                                            <div class="equipment-name-text">${eq.name}</div>
                                        </div>
                                    `).join('') || '<div class="empty-placeholder empty-equipment">Nincs berendez√©s</div>'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Add new screen before bottom nav
            const bottomNav = document.querySelector('.bottom-nav');
            bottomNav.parentNode.insertBefore(screenDiv, bottomNav);
            
            setupLongPress();
        }
        
        function toggleBranchInDetail(button) {
            const hierarchyItem = button.closest('.hierarchy-item');
            if (!hierarchyItem) return;
            
            const children = hierarchyItem.querySelector('.hierarchy-children');
            if (!children) return;
            
            const chevron = button.querySelector('.chevron');
            if (!chevron) return;
            
            children.classList.toggle('expanded');
            chevron.classList.toggle('expanded');
        }
        
        function goBackToHierarchy() {
            // Remove all dynamic detail screens
            document.querySelectorAll('[id^="distDetail_"], [id^="branchDetail_"], [id^="roomDetail_"]').forEach(s => s.remove());
            
            // Show hierarchy screen
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('hierarchyScreen').classList.add('active');
        }
        
        function goBackToRoom(roomId) {
            // Remove distributor detail screens
            document.querySelectorAll('[id^="distDetail_"]').forEach(s => s.remove());
            
            // Check if room detail screen exists
            const roomDetailScreen = document.getElementById('roomDetail_' + roomId);
            if (roomDetailScreen) {
                // Show existing room detail screen
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                roomDetailScreen.classList.add('active');
            } else {
                // Create new room detail screen
                showRoomDetails(roomId);
            }
        }
        
        // ============= LONG PRESS CONTEXT MENU =============
        // Long press functionality has been disabled
        function setupLongPress() {
            // Disabled
        }
        
        function handleLongPressStart(e) {
            // Disabled
        }
        
        function handleLongPressEnd(e) {
            // Disabled
        }
        
        function showContextMenu(e) {
            // Disabled
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }
        
        function editFromContext() {
            if (contextMenuTarget) {
                const type = contextMenuTarget.dataset.type;
                const id = contextMenuTarget.dataset.id;
                editItem(type, id);
            }
            closeContextMenu();
        }
        
        function deleteFromContext() {
            if (contextMenuTarget) {
                const type = contextMenuTarget.dataset.type;
                const id = contextMenuTarget.dataset.id;
                deleteItem(type, id);
            }
            closeContextMenu();
        }
        
        // ============= MODAL FUNCTIONS =============
        function openAddDistributorModal(roomId) {
            currentModalType = 'distributor-quick';
            editingItemId = null;
            window.currentRoomId = roomId; // Store for later use
            
            const modal = document.getElementById('addEditModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('modalForm');
            
            title.textContent = '√öj Eloszt√≥';
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Eloszt√≥ K√≥d</label>
                    <input type="text" class="form-input" id="distCode" placeholder="pl. K3-03BJC05">
                </div>
                <div class="form-group">
                    <label class="form-label">N√©v</label>
                    <input type="text" class="form-input" id="distName" placeholder="pl. H√°rmas Kaz√°neloszt√≥">
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function openAddBranchModal(distId) {
            currentModalType = 'branch';
            editingItemId = null;
            window.currentDistId = distId; // Store for later use
            
            const modal = document.getElementById('addEditModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('modalForm');
            
            title.textContent = '√öj Le√°gaz√°s';
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Le√°gaz√°s Neve</label>
                    <input type="text" class="form-input" id="branchName" placeholder="pl. H le√°gaz√°s">
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function openAddEquipmentModal(branchId) {
            currentModalType = 'equipment-quick';
            editingItemId = null;
            window.currentBranchId = branchId; // Store for later use
            
            const modal = document.getElementById('addEditModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('modalForm');
            
            title.textContent = '√öj Berendez√©s';
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Mez≈ë</label>
                    <input type="text" class="form-input" id="eqField" placeholder="pl. 1">
                </div>
                <div class="form-group">
                    <label class="form-label">KKS K√≥d</label>
                    <input type="text" class="form-input" id="eqKks" placeholder="pl. 13ETG10AF105">
                </div>
                <div class="form-group">
                    <label class="form-label">Berendez√©s N√©v</label>
                    <input type="text" class="form-input" id="eqName" placeholder="pl. Kaz√°nhamu kihord√≥ csiga M023">
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function openAddModal(type) {
            currentModalType = type;
            editingItemId = null;
            
            const modal = document.getElementById('addEditModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('modalForm');
            
            if (type === 'room') {
                title.textContent = '√öj Kapcsol√≥ T√©r';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="roomName" placeholder="pl. LV3 Kapcsol√≥t√©r">
                    </div>
                `;
            } else if (type === 'distributor') {
                title.textContent = '√öj Eloszt√≥';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Kapcsol√≥ T√©r</label>
                        <select class="form-select" id="distRoom">
                            ${appData.rooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eloszt√≥ K√≥d</label>
                        <input type="text" class="form-input" id="distCode" placeholder="pl. K3-03BJC05">
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="distName" placeholder="pl. H√°rmas Kaz√°neloszt√≥">
                    </div>
                `;
            } else if (type === 'branch') {
                title.textContent = '√öj Le√°gaz√°s';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Eloszt√≥</label>
                        <select class="form-select" id="branchDist">
                            ${appData.distributors.map(d => {
                                const room = appData.rooms.find(r => r.id === d.roomId);
                                return `<option value="${d.id}">${room ? room.name + ' ‚Ä∫ ' : ''}${d.code}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="branchName" placeholder="pl. A le√°gaz√°s">
                    </div>
                `;
            } else if (type === 'equipment') {
                // Get all branches with their full path
                const branchOptions = [];
                appData.rooms.forEach(room => {
                    appData.distributors.filter(d => d.roomId === room.id).forEach(dist => {
                        appData.branches.filter(b => b.distId === dist.id).forEach(branch => {
                            branchOptions.push({
                                id: branch.id,
                                label: `${room.name} ‚Ä∫ ${dist.code} ‚Ä∫ ${branch.name}`
                            });
                        });
                    });
                });
                
                title.textContent = '√öj Berendez√©s';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Le√°gaz√°s</label>
                        <select class="form-select" id="eqBranch">
                            ${branchOptions.map(b => `<option value="${b.id}">${b.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mez≈ë</label>
                        <input type="text" class="form-input" id="eqField" placeholder="pl. 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">KKS K√≥d</label>
                        <input type="text" class="form-input" id="eqKks" placeholder="pl. 13ETG10AF105">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Berendez√©s N√©v</label>
                        <input type="text" class="form-input" id="eqName" placeholder="pl. Kaz√°nhamu kihord√≥ csiga M023">
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function editItem(type, id) {
            currentModalType = type;
            editingItemId = id;
            
            const modal = document.getElementById('addEditModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('modalForm');
            
            if (type === 'room') {
                const item = appData.rooms.find(r => r.id === id);
                title.textContent = 'Kapcsol√≥ T√©r Szerkeszt√©se';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="roomName" value="${item.name}">
                    </div>
                `;
            } else if (type === 'distributor') {
                const item = appData.distributors.find(d => d.id === id);
                title.textContent = 'Eloszt√≥ Szerkeszt√©se';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Kapcsol√≥ T√©r</label>
                        <select class="form-select" id="distRoom">
                            ${appData.rooms.map(r => `<option value="${r.id}" ${r.id === item.roomId ? 'selected' : ''}>${r.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Eloszt√≥ K√≥d</label>
                        <input type="text" class="form-input" id="distCode" value="${item.code}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="distName" value="${item.name}">
                    </div>
                `;
            } else if (type === 'branch') {
                const item = appData.branches.find(b => b.id === id);
                title.textContent = 'Le√°gaz√°s Szerkeszt√©se';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Eloszt√≥</label>
                        <select class="form-select" id="branchDist">
                            ${appData.distributors.map(d => {
                                const room = appData.rooms.find(r => r.id === d.roomId);
                                return `<option value="${d.id}" ${d.id === item.distId ? 'selected' : ''}>${room ? room.name + ' ‚Ä∫ ' : ''}${d.code}</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√©v</label>
                        <input type="text" class="form-input" id="branchName" value="${item.name}">
                    </div>
                `;
            } else if (type === 'equipment') {
                const item = appData.equipment.find(e => e.id === id);
                const branchOptions = [];
                appData.rooms.forEach(room => {
                    appData.distributors.filter(d => d.roomId === room.id).forEach(dist => {
                        appData.branches.filter(b => b.distId === dist.id).forEach(branch => {
                            branchOptions.push({
                                id: branch.id,
                                label: `${room.name} ‚Ä∫ ${dist.code} ‚Ä∫ ${branch.name}`
                            });
                        });
                    });
                });
                
                title.textContent = 'Berendez√©s Szerkeszt√©se';
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Le√°gaz√°s</label>
                        <select class="form-select" id="eqBranch">
                            ${branchOptions.map(b => `<option value="${b.id}" ${b.id === item.branchId ? 'selected' : ''}>${b.label}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mez≈ë</label>
                        <input type="text" class="form-input" id="eqField" value="${item.field}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">KKS K√≥d</label>
                        <input type="text" class="form-input" id="eqKks" value="${item.kks}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Berendez√©s N√©v</label>
                        <input type="text" class="form-input" id="eqName" value="${item.name}">
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function saveModal() {
            if (currentModalType === 'room') {
                const name = document.getElementById('roomName').value.trim();
                if (!name) {
                    alert('K√©rlek add meg a nevet!');
                    return;
                }
                
                if (editingItemId) {
                    const item = appData.rooms.find(r => r.id === editingItemId);
                    item.name = name;
                } else {
                    appData.rooms.push({
                        id: 'room' + Date.now(),
                        name: name
                    });
                }
            } else if (currentModalType === 'distributor-quick') {
                const code = document.getElementById('distCode').value.trim();
                const name = document.getElementById('distName').value.trim();
                
                if (!code || !name) {
                    alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
                    return;
                }
                
                appData.distributors.push({
                    id: 'dist' + Date.now(),
                    roomId: window.currentRoomId,
                    code: code,
                    name: name
                });
                
                // Save and refresh views
                saveToLocalStorage();
                renderHierarchy();
                closeModal();
                // Refresh the edit distributor list for this room
                showEditRoomDistributors(window.currentRoomId);
                return;
            } else if (currentModalType === 'branch') {
                const name = document.getElementById('branchName').value.trim();
                if (!name) {
                    alert('K√©rlek add meg a nevet!');
                    return;
                }
                
                if (editingItemId) {
                    const item = appData.branches.find(b => b.id === editingItemId);
                    const distId = document.getElementById('branchDist') ? document.getElementById('branchDist').value : item.distId;
                    item.distId = distId;
                    item.name = name;
                } else {
                    // Use window.currentDistId if available (quick add), otherwise use select value
                    const distId = window.currentDistId || document.getElementById('branchDist').value;
                    appData.branches.push({
                        id: 'br' + Date.now(),
                        distId: distId,
                        name: name
                    });
                    
                    // If created via quick add, refresh the distributor branch view
                    if (window.currentDistId) {
                        saveToLocalStorage();
                        renderHierarchy();
                        closeModal();
                        showEditDistBranches(window.currentDistId);
                        return;
                    }
                }
            } else if (currentModalType === 'equipment-quick') {
                const field = document.getElementById('eqField').value.trim();
                const kks = document.getElementById('eqKks').value.trim();
                const name = document.getElementById('eqName').value.trim();
                
                if (!field || !name) {
                    alert('K√©rlek t√∂ltsd ki a k√∂telez≈ë mez≈ëket!');
                    return;
                }
                
                // Check for duplicate KKS code (only if KKS is not empty)
                if (kks) {
                    const isDuplicate = appData.equipment.some(e => 
                        e.kks && 
                        e.kks.toLowerCase() === kks.toLowerCase()
                    );
                    
                    if (isDuplicate) {
                        alert('‚ö†Ô∏è Ez a KKS k√≥d m√°r l√©tezik a rendszerben!\nK√©rlek adj meg egy m√°sik KKS k√≥dot.');
                        return;
                    }
                }
                
                appData.equipment.push({
                    id: 'eq' + Date.now(),
                    branchId: window.currentBranchId,
                    field: field,
                    kks: kks,
                    name: name
                });
                
                // Refresh the edit equipment view for this branch
                saveToLocalStorage();
                renderHierarchy();
                closeModal();
                showEditBranchEquipment(window.currentBranchId);
                return;
            } else if (currentModalType === 'distributor') {
                const roomId = document.getElementById('distRoom').value;
                const code = document.getElementById('distCode').value.trim();
                const name = document.getElementById('distName').value.trim();
                
                if (!code || !name) {
                    alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
                    return;
                }
                
                if (editingItemId) {
                    const item = appData.distributors.find(d => d.id === editingItemId);
                    item.roomId = roomId;
                    item.code = code;
                    item.name = name;
                } else {
                    appData.distributors.push({
                        id: 'dist' + Date.now(),
                        roomId: roomId,
                        code: code,
                        name: name
                    });
                }
            } else if (currentModalType === 'equipment') {
                const branchId = document.getElementById('eqBranch').value;
                const field = document.getElementById('eqField').value.trim();
                const kks = document.getElementById('eqKks').value.trim();
                const name = document.getElementById('eqName').value.trim();
                
                if (!field || !name) {
                    alert('K√©rlek t√∂ltsd ki a k√∂telez≈ë mez≈ëket!');
                    return;
                }
                
                // Check for duplicate KKS code (only if KKS is not empty)
                if (kks) {
                    const isDuplicate = appData.equipment.some(e => 
                        e.kks && 
                        e.kks.toLowerCase() === kks.toLowerCase() && 
                        e.id !== editingItemId
                    );
                    
                    if (isDuplicate) {
                        alert('‚ö†Ô∏è Ez a KKS k√≥d m√°r l√©tezik a rendszerben!\nK√©rlek adj meg egy m√°sik KKS k√≥dot.');
                        return;
                    }
                }
                
                if (editingItemId) {
                    const item = appData.equipment.find(e => e.id === editingItemId);
                    item.branchId = branchId;
                    item.field = field;
                    item.kks = kks;
                    item.name = name;
                } else {
                    appData.equipment.push({
                        id: 'eq' + Date.now(),
                        branchId: branchId,
                        field: field,
                        kks: kks,
                        name: name
                    });
                }
            }
            
            // Determine what to refresh based on what was edited
            let refreshContext = null;
            if (editingItemId) {
                if (currentModalType === 'room') {
                    refreshContext = { type: 'rooms' };
                } else if (currentModalType === 'distributor') {
                    const item = appData.distributors.find(d => d.id === editingItemId);
                    refreshContext = { type: 'distributors', roomId: item ? item.roomId : null };
                } else if (currentModalType === 'branch') {
                    const item = appData.branches.find(b => b.id === editingItemId);
                    refreshContext = { type: 'branches', distId: item ? item.distId : null };
                } else if (currentModalType === 'equipment') {
                    const item = appData.equipment.find(e => e.id === editingItemId);
                    refreshContext = { type: 'equipment', branchId: item ? item.branchId : null };
                }
            }
            
            saveToLocalStorage();
            renderAll();
            closeModal();
            
            // Refresh the current edit view if we edited something
            if (refreshContext) {
                if (refreshContext.type === 'rooms') {
                    goBackToEditRooms();
                } else if (refreshContext.type === 'distributors' && refreshContext.roomId) {
                    showEditRoomDistributors(refreshContext.roomId);
                } else if (refreshContext.type === 'branches' && refreshContext.distId) {
                    showEditDistBranches(refreshContext.distId);
                } else if (refreshContext.type === 'equipment' && refreshContext.branchId) {
                    showEditBranchEquipment(refreshContext.branchId);
                }
            }
        }
        
        function closeModal() {
            document.getElementById('addEditModal').classList.remove('active');
            currentModalType = null;
            editingItemId = null;
        }
        
        // ============= DETAIL MODAL =============
        function showEquipmentDetail(equipmentId) {
            const eq = appData.equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            const branch = appData.branches.find(b => b.id === eq.branchId);
            const dist = branch ? appData.distributors.find(d => d.id === branch.distId) : null;
            const room = dist ? appData.rooms.find(r => r.id === dist.roomId) : null;
            
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailModalTitle');
            const content = document.getElementById('detailModalContent');
            
            title.textContent = eq.kks || '(KKS n√©lk√ºl)';
            content.innerHTML = `
                <div class="detail-modal-row">
                    <div class="detail-modal-label">Berendez√©s n√©v</div>
                    <div class="detail-modal-value">${eq.name}</div>
                </div>
                <div class="detail-modal-row">
                    <div class="detail-modal-label">KKS k√≥d</div>
                    <div class="detail-modal-value">${eq.kks || '-'}</div>
                </div>
                <div class="detail-modal-row">
                    <div class="detail-modal-label">Mez≈ë</div>
                    <div class="detail-modal-value">${eq.field}</div>
                </div>
                <div class="detail-modal-row">
                    <div class="detail-modal-label">Le√°gaz√°s</div>
                    <div class="detail-modal-value">${branch ? branch.name : 'N/A'}</div>
                </div>
                <div class="detail-modal-row">
                    <div class="detail-modal-label">Eloszt√≥</div>
                    <div class="detail-modal-value">${dist ? dist.code + ' - ' + dist.name : 'N/A'}</div>
                </div>
                <div class="detail-modal-row">
                    <div class="detail-modal-label">Kapcsol√≥t√©r</div>
                    <div class="detail-modal-value">${room ? room.name : 'N/A'}</div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const emptyState = document.getElementById('emptyState');
            const backButton = document.getElementById('searchBackButton');
            
            searchInput.value = '';
            searchResults.classList.remove('active');
            searchResults.innerHTML = '';
            emptyState.style.display = 'block';
            backButton.style.display = 'none';
        }
        
        function deleteItem(type, id) {
            if (!confirm('Biztosan t√∂r√∂lni szeretn√©d?')) return;
            
            let refreshContext = null;
            
            if (type === 'room') {
                // Delete related distributors, branches, equipment
                const distIds = appData.distributors.filter(d => d.roomId === id).map(d => d.id);
                const branchIds = appData.branches.filter(b => distIds.includes(b.distId)).map(b => b.id);
                
                appData.equipment = appData.equipment.filter(e => !branchIds.includes(e.branchId));
                appData.branches = appData.branches.filter(b => !distIds.includes(b.distId));
                appData.distributors = appData.distributors.filter(d => d.roomId !== id);
                appData.rooms = appData.rooms.filter(r => r.id !== id);
                refreshContext = { type: 'rooms' };
            } else if (type === 'distributor') {
                // Delete related branches and equipment
                const dist = appData.distributors.find(d => d.id === id);
                const roomId = dist ? dist.roomId : null;
                const branchIds = appData.branches.filter(b => b.distId === id).map(b => b.id);
                
                appData.equipment = appData.equipment.filter(e => !branchIds.includes(e.branchId));
                appData.branches = appData.branches.filter(b => b.distId !== id);
                appData.distributors = appData.distributors.filter(d => d.id !== id);
                refreshContext = { type: 'distributors', roomId: roomId };
            } else if (type === 'branch') {
                // Delete related equipment
                const branch = appData.branches.find(b => b.id === id);
                const distId = branch ? branch.distId : null;
                appData.equipment = appData.equipment.filter(e => e.branchId !== id);
                appData.branches = appData.branches.filter(b => b.id !== id);
                refreshContext = { type: 'branches', distId: distId };
            } else if (type === 'equipment') {
                const equipment = appData.equipment.find(e => e.id === id);
                const branchId = equipment ? equipment.branchId : null;
                appData.equipment = appData.equipment.filter(e => e.id !== id);
                refreshContext = { type: 'equipment', branchId: branchId };
            }
            
            saveToLocalStorage();
            renderAll();
            
            // Refresh the current edit view if we're in edit mode
            if (refreshContext) {
                if (refreshContext.type === 'rooms') {
                    // Back to rooms list
                    goBackToEditRooms();
                } else if (refreshContext.type === 'distributors' && refreshContext.roomId) {
                    // Refresh the distributor list for this room
                    showEditRoomDistributors(refreshContext.roomId);
                } else if (refreshContext.type === 'branches' && refreshContext.distId) {
                    // Refresh the branch list for this distributor
                    showEditDistBranches(refreshContext.distId);
                } else if (refreshContext.type === 'equipment' && refreshContext.branchId) {
                    // Refresh the equipment list for this branch
                    showEditBranchEquipment(refreshContext.branchId);
                }
            }
        }
        
        // ============= EXPORT/IMPORT =============
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'equipment_data_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importDataFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (confirm('Ez fel√ºl√≠rja az √∂sszes jelenlegi adatot! Folytatod?')) {
                        appData = imported;
                        saveToLocalStorage();
                        renderAll();
                        alert('Sikeres import√°l√°s! ‚úÖ');
                    }
                } catch (err) {
                    alert('Hib√°s f√°jl form√°tum! ‚ùå');
                }
                // Reset file input
                input.value = '';
            };
            reader.readAsText(file);
        }
        
        // ============= START APP =============
        // PWA Install Prompt
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install banner
            const installBanner = document.getElementById('installBanner');
            const alreadyDismissed = localStorage.getItem('installPromptDismissed');
            
            if (!alreadyDismissed) {
                setTimeout(() => {
                    installBanner.classList.add('show');
                }, 2000); // Show after 2 seconds
            }
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            
            // Clear the deferredPrompt
            deferredPrompt = null;
            
            // Hide the banner
            document.getElementById('installBanner').classList.remove('show');
        });
        
        document.getElementById('installClose').addEventListener('click', () => {
            document.getElementById('installBanner').classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        });
        
        // Detect if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA telep√≠tve!');
            document.getElementById('installBanner').classList.remove('show');
        });
        
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js', { scope: './' })
                    .then((registration) => {
                        console.log('‚úÖ Service Worker regisztr√°lva:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Service Worker regisztr√°ci√≥ sikertelen:', error);
                    });
            });
        }
        
        // ============= OFFLINE INDICATOR =============
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            const text = document.getElementById('offlineText');
            
            if (!navigator.onLine) {
                indicator.classList.remove('hidden', 'online');
                text.textContent = 'Offline m√≥d';
            } else {
                indicator.classList.add('online');
                indicator.classList.remove('hidden');
                text.textContent = 'Online';
                
                // Hide after 3 seconds when online
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 3000);
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check on load
        window.addEventListener('load', () => {
            if (!navigator.onLine) {
                updateOnlineStatus();
            }
        });
        
        // App will be initialized after password check
    </script>
</body>
</html>